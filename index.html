<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bottom Menu Layout</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@700&display=swap');

        /* 1. 기본 설정 */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        :root {
            --stroke-width: 3px; 
            --border-color: #000;
        }

        html, body {
            width: 100%; height: 100%;
            overflow: hidden; 
            background-color: #fff;
            font-family: 'Noto Serif KR', serif;
            display: flex; user-select: none; overscroll-behavior: none; 
        }

        /* --- [왼쪽 패널] --- */
        .left-panel {
            flex: 4; height: 100%;
            display: flex; flex-direction: row; 
            border-right: var(--stroke-width) solid var(--border-color);
            background-color: #fff; z-index: 10;
        }

        .side-pillar {
            flex: 0 0 40px; height: 100%; background-color: #fff; z-index: 5;
        }
        .side-pillar.left { border-right: var(--stroke-width) solid var(--border-color); }
        .side-pillar.right { border-left: var(--stroke-width) solid var(--border-color); }

        .center-column {
            flex: 1; display: flex; flex-direction: column; height: 100%; overflow: hidden;
        }

        /* [2-1] 메인 화면 */
        .screen-area {
            flex: 1; min-height: 0; 
            display: flex; justify-content: center; align-items: center;
            position: relative; overflow: hidden;
        }

        /* [2-2] 한자 메뉴바 */
        .top-menu {
            flex: 0 0 70px; display: flex;
            border-top: var(--stroke-width) solid var(--border-color);
            border-bottom: var(--stroke-width) solid var(--border-color);
            background: #fff; z-index: 20;
        }

        .menu-item {
            flex: 1; min-width: 0;
            display: flex; justify-content: center; align-items: center;
            border-right: var(--stroke-width) solid var(--border-color);
            cursor: pointer; position: relative; overflow: hidden;
            font-size: min(36px, 2.5vw); font-weight: 700; line-height: 1;
            transition: background 0.3s, color 0.3s;
        }
        .menu-item:last-child { border-right: none; }
        .menu-item.active { background-color: #000; color: #fff; }

        @keyframes blink-flash {
            0%, 50%, 100% { background-color: #000; color: #fff; }
            25%, 75% { background-color: #fff; color: #000; }
        }
        .menu-item.blinking { animation: blink-flash 0.4s step-end forwards; }

        .ticker-container { width: 100%; height: 100%; position: relative; overflow: hidden; }
        .ticker-wrapper {
            position: absolute; top: 0; left: 0; width: 100%; height: 200%;
            display: flex; flex-direction: column;
            transform: translateY(-50%); 
            transition: transform 0.5s cubic-bezier(0.5, 0, 0.2, 1);
        }
        .ticker-char { flex: 1; display: flex; justify-content: center; align-items: center; width: 100%; font-size: inherit; font-weight: inherit; }
        .ticker-wrapper.switched { transform: translateY(0); }


        /* [2-3] 하단 자막바 */
        .bottom-bar {
            flex: 0 0 80px; 
            background: #fff;
            display: flex; justify-content: center; align-items: center;
            font-weight: 700;
            font-size: clamp(22px, 3.0vh, 32px);
            padding: 0 20px;
            text-align: center; white-space: pre-wrap;
        }


        /* SVG 스타일 공통 */
        .obj-svg {
            max-width: 65%; max-height: 65%; 
            width: 400px; height: 400px;
            display: none; opacity: 0; transition: opacity 0.5s ease;
            overflow: visible; 
        }
        .obj-svg.visible { display: block; opacity: 1; }
        
        .obj-svg path, .obj-svg line, .obj-svg circle, .obj-svg rect, .obj-svg polyline, .obj-svg ellipse {
            fill: none; 
            stroke: #000; 
            stroke-width: 1.5; 
            stroke-linecap: round; stroke-linejoin: round;
            vector-effect: non-scaling-stroke;
        }

        /* --- 개별 애니메이션 스타일 --- */

        /* 1. 볼 견(見) */
        @keyframes hand-wave {
            0% { transform: rotate(-15deg); }
            100% { transform: rotate(15deg); }
        }
        #svg-qin .pupil-hand {
            transform-origin: 50px 60px;
            animation: hand-wave 0.5s infinite alternate ease-in-out;
            transition: transform 0.5s, opacity 0.5s;
            opacity: 1;
        }
        #svg-qin.broken .pupil-hand {
            animation: none; transform: scale(0); opacity: 0;
        }
        #svg-qin .eye-lid {
            fill: none; stroke: #000; stroke-width: 3px;
            transition: d 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #svg-qin.broken .eye-lid {
            d: path("M10 50 Q50 50 90 50 Q50 50 10 50 Z");
        }
        
        /* 2. 길 도(道) */
        #svg-dao path, #svg-dao circle {
            stroke: #000; stroke-width: 3px; stroke-linecap: round; fill: none;
            transition: all 0.5s ease;
        }
        #svg-dao .destination {
            fill: #000; stroke: none; transition: transform 0.5s, opacity 0.5s;
        }
        #svg-dao .path-dashed {
            stroke-dasharray: 0, 8; stroke-linecap: round;
            clip-path: inset(0 0 0 0); 
            transition: clip-path 1.5s ease-in-out; 
        }
        @keyframes try-move {
            0% { transform: translateY(0); }
            30% { transform: translateY(20px); }
            50% { transform: translateY(15px); }
            100% { transform: translateY(10px) scale(0.8);}
        }
        #svg-dao.broken .path-dashed { clip-path: inset(100% 0 0 0); }
        #svg-dao.broken .destination { animation: try-move 2s forwards; }

        /* 3. 공장(廠) */
        #svg-chang path, #svg-chang circle, #svg-chang line { stroke-width: 3px; }
        #svg-chang .gear { 
            transform-origin: center; animation: spin 4s linear infinite; transition: opacity 0.5s; 
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        #svg-chang.broken .gear { opacity: 0; animation: none; }
        
        /* 4. 날 비(飛) */
        #svg-fei .wing {
            stroke: #000; stroke-width: 3px; stroke-linecap: round; stroke-linejoin: round; fill: none;
            transform-origin: 50px 85px; 
        }
        @keyframes wing-flap-left { 0% { transform: rotate(0deg); } 100% { transform: rotate(-15deg); } }
        @keyframes wing-flap-right { 0% { transform: rotate(0deg); } 100% { transform: rotate(15deg); } }
        @keyframes wing-fall-gravity {
            0% { transform: rotate(0deg) translate(0, 0); opacity: 1; animation-timing-function: cubic-bezier(0.5, 0, 1, 1); }
            20% { transform: rotate(15deg) translate(5px, -5px); opacity: 1; }
            100% { transform: rotate(120deg) translate(80px, 200px); opacity: 0; }
        }
        @keyframes wing-sag-left {
            0% { transform: rotate(0deg); }
            60% { transform: rotate(-35deg) translateY(10px); }
            80% { transform: rotate(-30deg) translateY(8px); }
            100% { transform: rotate(-35deg) translateY(10px); opacity: 0.6; }
        }
        #svg-fei .wing-left { animation: wing-flap-left 1.2s ease-in-out infinite alternate; }
        #svg-fei .wing-right { animation: wing-flap-right 1.2s ease-in-out infinite alternate; }
        #svg-fei.broken .wing-left { animation: wing-sag-left 2s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        #svg-fei.broken .wing-right { animation: wing-fall-gravity 1.5s forwards; }
        
        /* 5. 들을 청(聽) */
        #svg-ting .ear-part {
            fill: none; stroke: #000; stroke-width: 3px; stroke-linecap: round; stroke-linejoin: round;
            transition: opacity 0.3s ease;
        }
        #svg-ting .sound-signal {
            fill: none; stroke: #000; stroke-width: 3px; stroke-linecap: round;
            stroke-dasharray: 20 1500; stroke-dashoffset: 20; 
        }
        @keyframes signal-poke-v2 {
            0% { stroke-dashoffset: 20; opacity: 0; }
            10% { opacity: 1; }
            35% { stroke-dashoffset: -110; } 
            50% { stroke-dashoffset: -100; } 
            65% { stroke-dashoffset: -110; } 
            80% { stroke-dashoffset: -110; opacity: 1; }
            100% { stroke-dashoffset: -110; opacity: 0; }
        }
        @keyframes signal-pass-v2 {
            0% { stroke-dashoffset: 20; opacity: 1; }
            100% { stroke-dashoffset: -400; opacity: 1; }
        }
        #svg-ting .sound-signal { animation: signal-poke-v2 1.5s cubic-bezier(0.25, 1, 0.5, 1) infinite; }
        #svg-ting.broken .ear-part { opacity: 0; }
        #svg-ting.broken .sound-signal { opacity: 1; animation: signal-pass-v2 1.0s linear infinite !important; }
        
        /* 6. 옮길 운(運) */
        #svg-yun path, #svg-yun rect, #svg-yun circle, #svg-yun line {
            stroke: #000; stroke-width: 3px; stroke-linecap: round; stroke-linejoin: round; fill: none;
            vector-effect: non-scaling-stroke;
        }
        #svg-yun .cargo-box { fill: #000; stroke: none; transform-origin: center; transition: transform 0.5s; }
        @keyframes spin-tire { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #svg-yun .tire-spin { transform-origin: 0 0; animation: spin-tire 1.5s linear infinite; }
        @keyframes roll-stop-left {
            0% { transform: translate(35px, 75px); }
            100% { transform: translate(-40px, 85px); opacity: 1; } 
        }
        @keyframes roll-stop-right {
            0% { transform: translate(65px, 75px); }
            100% { transform: translate(140px, 85px); opacity: 1; }
        }
        @keyframes spin-down-left { 0% { transform: rotate(0deg); } 100% { transform: rotate(-720deg); } }
        @keyframes spin-down-right { 0% { transform: rotate(0deg); } 100% { transform: rotate(720deg); } }
        @keyframes body-collapse {
            0% { transform: translateY(0) rotate(0); }
            30% { transform: translateY(5px) rotate(-2deg); }
            100% { transform: translateY(18px) rotate(-12deg); }
        }
        @keyframes cargo-spill {
            0% { transform: translate(0, 0) rotate(0); }
            30% { transform: translate(0, 5px) rotate(-2deg); }
            100% { transform: translate(-25px, 35px) rotate(-45deg); opacity: 1; } 
        }
        #svg-yun.broken .wheel.left { animation: roll-stop-left 2s ease-out forwards; }
        #svg-yun.broken .wheel.left .tire-spin { animation: spin-down-left 2s ease-out forwards; }
        #svg-yun.broken .wheel.right { animation: roll-stop-right 2s ease-out forwards; }
        #svg-yun.broken .wheel.right .tire-spin { animation: spin-down-right 2s ease-out forwards; }
        #svg-yun .cart-body { transform-origin: 50px 70px; transition: transform 0.5s; }
        #svg-yun.broken .cart-body { animation: body-collapse 0.6s cubic-bezier(0.5, 0, 0.5, 1) forwards; }
        #svg-yun.broken .cargo-box { animation: cargo-spill 0.7s cubic-bezier(0.2, 0.6, 0.3, 1) forwards; }
        
        /* 7. 가릴 선(選) */
        #svg-xuan .clipboard rect, #svg-xuan .clipboard line, #svg-xuan .pencil {
            stroke: #000; stroke-width: 3px; stroke-linecap: round; stroke-linejoin: round; fill: none;
        }
        @keyframes try-check-move {
            0% { transform: translate(0, 0); }
            40% { transform: translate(-15px, -10px); }
            50% { transform: translate(-15px, -10px); }
            100% { transform: translate(0, 0); }
        }
        @keyframes tremble-fear {
            0% { transform: translate(-15px, -10px) rotate(0deg); }
            25% { transform: translate(-16px, -11px) rotate(-2deg); }
            50% { transform: translate(-14px, -9px) rotate(2deg); }
            75% { transform: translate(-16px, -9px) rotate(-2deg); }
            100% { transform: translate(-15px, -10px) rotate(0deg); }
        }
        #svg-xuan .pencil-wrapper { transition: transform 0.5s ease; animation: try-check-move 2s ease-in-out infinite; }
        #svg-xuan.broken .pencil-wrapper { animation: tremble-fear 0.1s linear infinite !important; opacity: 1; }
        #svg-xuan.broken .clipboard { opacity: 1; }
        
        /* 8. 나아갈 진(進) */
        #svg-jin .arrow-shaft, #svg-jin path {
            stroke: #000; stroke-width: 3px; stroke-linecap: round; stroke-linejoin: round; transition: opacity 0.3s;
        }
        #svg-jin .arrow-head-piece { 
            fill: #000; stroke: none; transform-origin: center;
            transition: transform 1.0s cubic-bezier(0.6, -0.28, 0.735, 0.045), opacity 1.0s;
        }
        #svg-jin.broken .arrow-shaft, #svg-jin.broken path:nth-last-child(1) { opacity: 0; }
        #svg-jin.broken .arrow-head-piece { transform: translate(60px, 150px) rotate(90deg); }
        
        /* 9. 사랑 애(愛) - 하트 분리 */
        #svg-ai {
            transform: scale(0.7); transform-origin: center; overflow: visible; 
            outline: none !important; border: none !important;
        }
        #svg-ai .heart-part {
            fill: #000 !important; stroke: none !important; transform-origin: center;
            transition: transform 1.2s cubic-bezier(0.1, 0.7, 1.0, 0.1), opacity 1.2s ease;
        }
        #svg-ai.broken .heart-left { transform: translate(-60px, 40px) rotate(-25deg); opacity: 0; }
        #svg-ai.broken .heart-right { transform: translate(60px, -40px) rotate(25deg); opacity: 0; }

        /* --- [오른쪽 패널] --- */
        .right-panel {
            flex: 1.2; height: 100%;
            background-color: #000; 
            position: relative; overflow: hidden;
            border-left: var(--stroke-width) solid var(--border-color);
        }
        
        #physics-svg {
            display: block; width: 100%; height: 100%; cursor: default;
        }

        .rope-line { fill: none; stroke: #fff; stroke-width: 3px; stroke-linecap: round; }
        .handle-circle { fill: #000; stroke: #fff; stroke-width: 3px; }
        .handle-text {
            fill: #fff; font-family: 'Noto Serif KR', serif;
            font-weight: 700; font-size: 36px;
            text-anchor: middle; dominant-baseline: middle; user-select: none;
        }

    </style>
</head>
<body>

    <div class="left-panel">
        <div class="side-pillar left"></div>

        <div class="center-column">
            
            <div class="screen-area">
                <svg id="svg-qin" class="obj-svg" viewBox="0 0 100 100">
                    <path class="eye-lid" d="M10 50 Q50 10 90 50 Q50 90 10 50 Z" />
                    <image class="pupil-hand"
                           href="https://raw.githubusercontent.com/youngwookim11/svg-storage/443096b94239a231313b3def25ddda246fd4602c/%E1%84%89%E1%85%A9%E1%86%AB%E1%84%87%E1%85%A1%E1%84%83%E1%85%A1%E1%86%A8.png"
                           x="36" y="34" width="28" height="28" />
                </svg>
                
                <svg id="svg-dao" class="obj-svg" viewBox="0 0 100 100">
                    <path d="M20 90 Q40 50 45 20" /><path d="M80 90 Q60 50 55 20" />
                    <path class="path-dashed" d="M50 90 Q50 50 50 20" />
                    <circle class="destination" cx="50" cy="15" r="5" fill="#000"/>
                </svg>
                
                <svg id="svg-chang" class="obj-svg" viewBox="0 0 100 100">
                    <path class="factory-roof" d="M10 70 L10 40 L30 30 L30 40 L50 30 L50 40 L70 30 L70 70 Z" />
                    <g class="gear" style="transform-box: fill-box;">
                        <circle cx="40" cy="55" r="8" />
                        <path d="M40 45 L40 65 M30 55 L50 55 M33 48 L47 62 M47 48 L33 62" />
                    </g>
                </svg>
                
                <svg id="svg-fei" class="obj-svg" viewBox="0 0 100 100">
                    <path class="wing wing-left" d="M50 85 Q 45 80, 40 70 Q 20 60, 5 30 Q 10 20, 25 15 Q 40 10, 50 20 Q 45 30, 40 40 Q 30 40, 20 30 Q 25 45, 35 50 Q 30 60, 25 55 Q 35 70, 45 65 Q 48 75, 50 85 Z" />
                    <path class="wing wing-right" d="M50 85 Q 55 80, 60 70 Q 80 60, 95 30 Q 90 20, 75 15 Q 60 10, 50 20 Q 55 30, 60 40 Q 70 40, 80 30 Q 75 45, 65 50 Q 70 60, 75 55 Q 65 70, 55 65 Q 52 75, 50 85 Z" />
                </svg>

                <svg id="svg-ting" class="obj-svg" viewBox="0 0 100 100">
                    <g class="ear-group" transform="translate(25, 12) scale(0.75)">
                        <path class="ear-part" d="M9.53,84.37c4.24.21,3.44,4.42,4.09,7.2,3.26,13.96,24.78,12.89,26.04-2.6.79-9.79.92-15.66,6.81-24.06,6.48-9.25,17.33-14.47,18.89-26.63C68.36,14.75,46.82-3.99,23.92,2.97,12.92,6.32,4.15,16.23,2.07,27.53c-.41,2.23-.22,4.63-.57,6.64" />
                        <path class="ear-part" d="M9.59,65.02c2.96-1.93,5.09.86,8.07,1.1,12.14.96,14.38-16.2,3.29-18.83-2.4-.57-4.99.39-6.67-1.67-.92-1.13-.94-2.53-1.01-3.93-.28-5.43-.6-10.59,1.41-15.73,6.56-16.83,29.72-19.24,39.63-4.11,2.21,3.37,4.37,9.45,3.55,13.47" />
                    </g>
                    <path class="sound-signal" d="M-50 65 L 150 65" />
                </svg>
                
                <svg id="svg-yun" class="obj-svg" viewBox="0 0 100 100">
                    <rect class="cargo-box" x="35" y="35" width="30" height="25" />
                    <g class="cart-body">
                        <path d="M20 70 L80 70 L80 60 L20 60 Z" />
                        <path d="M25 60 L25 50" />
                    </g>
                    <g class="wheel left" transform="translate(35, 75)">
                        <g class="tire-spin">
                            <circle cx="0" cy="0" r="8" />
                            <line x1="0" y1="-8" x2="0" y2="8" />
                            <line x1="-8" y1="0" x2="8" y2="0" />
                        </g>
                    </g>
                    <g class="wheel right" transform="translate(65, 75)">
                        <g class="tire-spin">
                            <circle cx="0" cy="0" r="8" />
                            <line x1="0" y1="-8" x2="0" y2="8" />
                            <line x1="-8" y1="0" x2="8" y2="0" />
                        </g>
                    </g>
                </svg>
                
                <svg id="svg-xuan" class="obj-svg" viewBox="0 0 100 100">
                    <g class="clipboard">
                        <rect x="25" y="20" width="50" height="60" rx="3" />
                        <line x1="35" y1="35" x2="65" y2="35" />
                        <line x1="35" y1="45" x2="65" y2="45" />
                        <line x1="35" y1="55" x2="65" y2="55" />
                    </g>
                    <g class="pencil-wrapper">
                        <path class="pencil" d="M60 55 L 85 30 L 95 40 L 70 65 L 55 70 L 60 55 M 70 65 L 60 55" />
                    </g>
                </svg>
                
                <svg id="svg-jin" class="obj-svg" viewBox="0 0 100 100">
                    <line class="arrow-shaft" x1="10" y1="50" x2="70" y2="50" />
                    <path class="arrow-head-piece" d="M65 35 L85 50 L65 65 L70 50 Z" />
                    <path d="M10 50 L5 40 M10 50 L5 60" />
                </svg>
                
                <svg id="svg-ai" class="obj-svg" viewBox="0 0 122.54 112.02">
                    <path class="heart-part heart-left" 
                          d="M68.34,60.17l-17.1-9.4,14.53-22.65-10.26-8.98,4.65-9.68C46.08-3.49,24.17-3.14,10.51,10.51h0c-14.02,14.02-14.02,36.74,0,50.76h0l50.33,50.33-6.18-36.47,13.68-14.96Z"/>
                    <path class="heart-part heart-right" 
                          d="M112.02,61.27c14.02-14.02,14.02-36.74,0-50.76h0c-14.02-14.02-36.74-14.02-50.76,0h0c-.36-.36-.73-.71-1.11-1.05l-4.65,9.68,10.26,8.98-14.53,22.65,17.1,9.4-13.68,14.96,6.18,36.47.43.43,50.76-50.76Z"/>
                </svg>
            </div>

            <div class="top-menu" id="menu-container">
                <div class="menu-item" data-target="svg-qin" data-missing="見" data-msg="볼 수(見) 없는데, 어찌 서로 친(親)할 수 있는가?">
                    <div class="ticker-container"><div class="ticker-wrapper"><div class="ticker-char new">亲</div><div class="ticker-char old">親</div></div></div>
                </div>
                <div class="menu-item" data-target="svg-dao" data-missing="道" data-msg="길(道)이 없는데, 어찌 인도(導)할 수 있는가?">
                    <div class="ticker-container"><div class="ticker-wrapper"><div class="ticker-char new">导</div><div class="ticker-char old">導</div></div></div>
                </div>
                <div class="menu-item" data-target="svg-chang" data-missing="敞" data-msg="안이 비었는데, 어찌 공장(廠)이라 할 수 있는가?">
                    <div class="ticker-container"><div class="ticker-wrapper"><div class="ticker-char new">厂</div><div class="ticker-char old">廠</div></div></div>
                </div>
                <div class="menu-item" data-target="svg-fei" data-missing="翼" data-msg="날개가 한쪽(飞)만 있는데 하늘은 어떻게 나는가?(飛)">
                    <div class="ticker-container"><div class="ticker-wrapper"><div class="ticker-char new">飞</div><div class="ticker-char old">飛</div></div></div>
                </div>
                <div class="menu-item" data-target="svg-ting" data-missing="耳" data-msg="귀(耳)가 없는데, 어찌 들을(聽) 수 있는가?">
                    <div class="ticker-container"><div class="ticker-wrapper"><div class="ticker-char new">听</div><div class="ticker-char old">聽</div></div></div>
                </div>
                <div class="menu-item" data-target="svg-yun" data-missing="車" data-msg="수레(車)가 없으면(运) 어떻게 옮기나?(運)">
                    <div class="ticker-container"><div class="ticker-wrapper"><div class="ticker-char new">运</div><div class="ticker-char old">運</div></div></div>
                </div>
                <div class="menu-item" data-target="svg-xuan" data-missing="巽" data-msg="신중함(巽)이 없는데, 어찌 고를(選) 수 있는가?">
                    <div class="ticker-container"><div class="ticker-wrapper"><div class="ticker-char new">选</div><div class="ticker-char old">選</div></div></div>
                </div>
                <div class="menu-item" data-target="svg-jin" data-missing="隹" data-msg="나아감(隹)이 없는데, 어찌 전진(進)할 수 있는가?">
                    <div class="ticker-container"><div class="ticker-wrapper"><div class="ticker-char new">进</div><div class="ticker-char old">進</div></div></div>
                </div>
                <div class="menu-item" data-target="svg-ai" data-missing="心" data-msg="마음(心)이 없는데, 사랑(愛)을 할 수 있는가?">
                    <div class="ticker-container"><div class="ticker-wrapper"><div class="ticker-char new">爱</div><div class="ticker-char old">愛</div></div></div>
                </div>
            </div>

            <div class="bottom-bar" id="text-display"></div>
        </div>

        <div class="side-pillar right"></div>
    </div>

    <div class="right-panel">
        <svg id="physics-svg" preserveAspectRatio="none"></svg>
    </div>

    <script>
        const menuItems = document.querySelectorAll('.menu-item');
        const textDisplay = document.getElementById('text-display');
        const svgCanvas = document.getElementById('physics-svg');

        let activeItem = null;
        let isBroken = false;
        let width, height;
        let mouse = { x: 0, y: 0, isDown: false };
        let stringObj = null; 
        
        const GRAVITY = 0.8;
        const AIR_RESISTANCE = 0.99; 
        const DAMPING = 0.92;
        const SPRING_STRENGTH = 0.08;
        const SPRING_DAMPING = 0.90;
        
        function resize() {
            const rect = svgCanvas.parentElement.getBoundingClientRect();
            width = rect.width;
            height = rect.height;
            svgCanvas.setAttribute('viewBox', `0 0 ${width} ${height}`);
        }
        window.addEventListener('resize', resize);
        setTimeout(resize, 100);

        function getSvgPos(e) {
            const rect = svgCanvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: clientX - rect.left, y: clientY - rect.top };
        }

        svgCanvas.addEventListener('mousedown', e => {
            const pos = getSvgPos(e);
            mouse.x = pos.x; mouse.y = pos.y; mouse.isDown = true;
            if (stringObj) stringObj.checkDragStart();
        });
        window.addEventListener('mousemove', e => {
            const rect = svgCanvas.getBoundingClientRect();
            mouse.x = e.clientX - rect.left; mouse.y = e.clientY - rect.top;
        });
        window.addEventListener('mouseup', () => {
            mouse.isDown = false;
            if (stringObj) stringObj.release();
        });

        svgCanvas.addEventListener('touchstart', e => {
            e.preventDefault();
            const pos = getSvgPos(e);
            mouse.x = pos.x; mouse.y = pos.y; mouse.isDown = true;
            if (stringObj) stringObj.checkDragStart();
        });
        window.addEventListener('touchmove', e => {
            const pos = getSvgPos(e);
            mouse.x = pos.x; mouse.y = pos.y;
        });
        window.addEventListener('touchend', () => {
            mouse.isDown = false;
            if (stringObj) stringObj.release();
        });

        class StringObj {
            constructor(text) {
                this.anchorX = width / 2; 
                this.anchorY = 0; 
                this.targetLength = 120; 
                this.currentLength = -150;
                this.velocityY = 0;        
                this.circleX = this.anchorX;
                this.circleY = -150;
                this.radius = 36; 
                this.text = text; 
                this.state = 'dropping'; 
                this.swingAngle = 0;
                this.swingVelocity = 0;
                this.brokenLineLength = 80;
                this.fallObj = null; 
                this.createSvgElements();
            }

            createSvgElements() {
                this.ropePath = document.createElementNS("http://www.w3.org/2000/svg", "path");
                this.ropePath.setAttribute("class", "rope-line");
                svgCanvas.appendChild(this.ropePath);

                this.handleGroup = document.createElementNS("http://www.w3.org/2000/svg", "g");
                svgCanvas.appendChild(this.handleGroup);

                this.handleCircle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                this.handleCircle.setAttribute("r", this.radius);
                this.handleCircle.setAttribute("class", "handle-circle");
                this.handleGroup.appendChild(this.handleCircle);

                this.handleText = document.createElementNS("http://www.w3.org/2000/svg", "text");
                this.handleText.setAttribute("class", "handle-text");
                this.handleText.textContent = this.text;
                this.handleText.setAttribute("dy", "2"); 
                this.handleGroup.appendChild(this.handleText);

                this.stubLine = document.createElementNS("http://www.w3.org/2000/svg", "line");
                this.stubLine.setAttribute("class", "rope-line");
                this.stubLine.setAttribute("x1", 0); this.stubLine.setAttribute("y1", 0);
                this.stubLine.setAttribute("x2", 0); this.stubLine.setAttribute("y2", 0);
                this.handleGroup.insertBefore(this.stubLine, this.handleCircle); 
            }

            remove() {
                if(this.ropePath) this.ropePath.remove();
                if(this.handleGroup) this.handleGroup.remove();
            }

            update() {
                if (this.state === 'dropping') {
                    const force = (this.targetLength - this.currentLength) * SPRING_STRENGTH;
                    this.velocityY += force;
                    this.velocityY *= SPRING_DAMPING;
                    this.currentLength += this.velocityY;
                    this.circleX = this.anchorX; 
                    this.circleY = this.anchorY + this.currentLength;

                    if (Math.abs(this.velocityY) < 0.1 && Math.abs(this.targetLength - this.currentLength) < 1) {
                        this.state = 'idle';
                        this.currentLength = this.targetLength;
                    }
                }
                else if (this.state === 'dragging') {
                    const targetX = mouse.x;
                    const targetY = mouse.y;
                    this.circleX += (targetX - this.circleX) * 0.4;
                    this.circleY = targetY; 
                    const distY = this.circleY - this.anchorY;
                    if (distY > 350) this.break();
                }
                else if (this.state === 'idle') {
                    this.anchorX = width / 2; 
                    const targetY = this.anchorY + this.targetLength;
                    this.circleY += (targetY - this.circleY) * 0.1;
                    this.circleX += (this.anchorX - this.circleX) * 0.1;
                }
                else if (this.state === 'broken') {
                    const angularAccel = -0.015 * Math.sin(this.swingAngle);
                    this.swingVelocity += angularAccel;
                    this.swingVelocity *= DAMPING;
                    this.swingAngle += this.swingVelocity;
                    if (this.fallObj) {
                        this.fallObj.vy += GRAVITY;
                        this.fallObj.vx *= AIR_RESISTANCE;
                        this.fallObj.x += this.fallObj.vx;
                        this.fallObj.y += this.fallObj.vy;
                        this.fallObj.rotation += this.fallObj.vr;
                    }
                }
                this.drawSvg();
            }

            drawSvg() {
                if (this.state === 'broken') {
                    const endX = this.anchorX + Math.sin(this.swingAngle) * this.brokenLineLength;
                    const endY = this.anchorY + Math.cos(this.swingAngle) * this.brokenLineLength;
                    this.ropePath.setAttribute("d", `M${this.anchorX},${this.anchorY} L${endX},${endY}`);

                    if (this.fallObj) {
                        const deg = this.fallObj.rotation * (180 / Math.PI);
                        this.handleGroup.setAttribute("transform", 
                            `translate(${this.fallObj.x}, ${this.fallObj.y}) rotate(${deg})`);
                        this.stubLine.setAttribute("y2", -this.fallObj.stubLen);
                    }
                } else {
                    this.ropePath.setAttribute("d", `M${this.anchorX},${this.anchorY} L${this.circleX},${this.circleY}`);
                    this.handleGroup.setAttribute("transform", `translate(${this.circleX}, ${this.circleY})`);
                    this.stubLine.setAttribute("y2", 0);
                }
            }

            checkDragStart() {
                if (this.state === 'broken' || this.state === 'dropping') return;
                const dx = mouse.x - this.circleX;
                const dy = mouse.y - this.circleY;
                if (Math.sqrt(dx*dx + dy*dy) < this.radius + 10) {
                    this.state = 'dragging';
                }
            }

            release() {
                if (this.state === 'dragging') {
                    this.state = 'idle';
                }
            }

            break() {
                this.state = 'broken';
                isBroken = true;
                const dx = this.circleX - this.anchorX;
                const dy = this.circleY - this.anchorY;
                this.swingAngle = Math.atan2(dx, dy);
                this.swingVelocity = -dx * 0.01; 
                this.fallObj = {
                    x: this.circleX, y: this.circleY,
                    vx: (this.circleX - this.anchorX) * 0.1, 
                    vy: (this.circleY - this.anchorY) * 0.1, 
                    vr: (Math.random() - 0.5) * 0.2, 
                    stubLen: 20, rotation: this.swingAngle
                };
                triggerPageAction();
            }
        }

        function activateSystem(item) {
            if (stringObj) stringObj.remove();
            activeItem = item;
            isBroken = false;
            item.classList.add('active');
            
            const targetId = item.getAttribute('data-target');
            const targetSvg = document.getElementById(targetId);
            if(targetSvg) {
                targetSvg.classList.add('visible');
                targetSvg.classList.remove('broken');
                targetSvg.style.opacity = '1';
            }
            resize(); 
            const missingText = item.getAttribute('data-missing');
            stringObj = new StringObj(missingText);
            textDisplay.innerHTML = "";
        }

        function deactivateSystem() {
            if (activeItem) {
                const targetId = activeItem.getAttribute('data-target');
                const targetSvg = document.getElementById(targetId);
                if(targetSvg) {
                    targetSvg.classList.remove('visible');
                    targetSvg.classList.remove('broken');
                }
                activeItem.classList.remove('active');
                activeItem.classList.remove('blinking');
                const ticker = activeItem.querySelector('.ticker-wrapper');
                ticker.classList.remove('switched');
            }
            activeItem = null;
            isBroken = false;
            if (stringObj) {
                stringObj.remove();
                stringObj = null;
            }
            textDisplay.innerHTML = "";
        }

        function triggerPageAction() {
            if (!activeItem) return;
            const targetId = activeItem.getAttribute('data-target');
            const targetSvg = document.getElementById(targetId);
            if(targetSvg) targetSvg.classList.add('broken');
            
            activeItem.classList.add('blinking');
            
            setTimeout(() => {
                const ticker = activeItem.querySelector('.ticker-wrapper');
                ticker.classList.add('switched');
                setTimeout(() => activeItem.classList.remove('blinking'), 100);
                const msg = activeItem.getAttribute('data-msg');
                typeWriter(msg);
            }, 400);
        }

        function typeWriter(text) {
            textDisplay.innerHTML = "";
            let i = 0;
            function type() {
                if (i < text.length) {
                    textDisplay.innerHTML += text.charAt(i);
                    i++;
                    setTimeout(type, 60);
                }
            }
            type();
        }

        menuItems.forEach((item) => {
            item.addEventListener('click', () => {
                if (activeItem) deactivateSystem();
                if (activeItem !== item) activateSystem(item);
            });
        });

        function animate() {
            if (stringObj) stringObj.update();
            requestAnimationFrame(animate);
        }
        animate();

    </script>
</body>
</html>
